VERSION=3.4.37
date >> /root/install.log
echo "install ${VERSION} started" >> /root/install.log

# Get required files
echo "getting files" >> /root/install.log
rm /root/*.tar
rm /root/startnednet2b
rm -rf /tmp/nednet2binstall
mkdir /tmp/nednet2binstall
cd /tmp/nednet2binstall
curl https://openwrt.neducation.ca/nednet2binstall.${VERSION}.tar.gz --output nednet2binstall.${VERSION}.tar.gz
gunzip nednet2binstall.${VERSION}.tar.gz
tar xf nednet2binstall.${VERSION}.tar

# Copy files to /root
echo "copying required files to /root" >> /root/install.log
cp id_glinet2 /root
cp nedSchoolTemplate.html /root
cp nedGeneralTemplate.html /root
cp nedconnectTemplate.html /root
cp wifi* /root
cp qos* /root

echo "getting MAC" >> /root/install.log
MAC=$(ifconfig eth0 | grep HWaddr | cut -d ' ' -f 11 | cut -c 11- | sed 's/://g')

# Set up login prompt
echo "PS1='\u@${MAC}:\w# '" > /root/.profile

# Set timezone
uci set system.@system[0].zonename='America/Regina'
uci set system.@system[0].timezone='CST6'
uci commit system

# Configure LTE
uci -q del network.modem_1_1_2
uci set network.modem_1_1_2=interface
uci set network.modem_1_1_2.ifname='3g-modem'
uci set network.modem_1_1_2.service='umts'
uci set network.modem_1_1_2.apn='pda.stm.sk.ca'
uci set network.modem_1_1_2.proto='3g'
uci set network.modem_1_1_2.device='/dev/ttyUSB3'
uci set network.modem_1_1_2.metric='40'
uci set network.modem_1_1_2.disabled='0'
uci commit network

uci set firewall.@zone[1].network='wan wan6 modem_1_1_2'
uci del_list firewall.@zone[1].list='wan'
uci del_list firewall.@zone[1].list='wan6'
uci commit firewall

# Configuring wireless
if grep -q gl-x750 "/etc/board.json"; then
    echo "setting wireless gl-x750" >> /root/install.log
    uci set wireless.default_radio0.ssid="WShighspeed-${MAC}-5G"
    uci set wireless.default_radio0.key='goodlife'
    uci set wireless.default_radio1.ssid="WShighspeed-${MAC}"
    uci set wireless.default_radio1.key='goodlife'
    uci set wireless.guest5g.ssid="WSstandard-${MAC}-5G"
    uci set wireless.guest5g.key='goodlife'
    uci set wireless.guest2g.ssid="WSstandard-${MAC}"
    uci set wireless.guest2g.key='goodlife'
    uci set wireless.guest2g.disabled='0'
    uci set wireless.guest5g.disabled='0'
    uci commit wireless
fi

if grep -q gl-mifi "/etc/board.json"; then
    echo "setting wireless gl-mifi" >> /root/install.log
    uci set wireless.default_radio0.ssid="WShighspeed-${MAC}"
    uci set wireless.default_radio0.key='goodlife'
    uci set wireless.guest2g.ssid="WSstandard-${MAC}"
    uci set wireless.guest2g.key='goodlife'
    uci set wireless.guest2g.disabled='0'
    uci commit wireless
fi

# Remove IPv6
echo "removing IPv6" >> /root/install.log
uci delete network.globals
uci commit network

# Disable nodogsplash
echo "disable nodogsplash" >> /root/install.log
uci set nodogsplash.@nodogsplash[0].enabled='0'
uci commit nodogsplash

# DNS
echo "adjust dhcp" >> /root/install.log
cp dhcp /etc/config
rm /etc/config/glqos
uci set glconfig.general.force_dns=''
uci commit glconfig

# Clear possible rule for mapping blocking page
cp firewall.user /etc/firewall.user

# Configure lighttpd
echo "Configure lighttpd" >> /root/install.log
cp lighttpd.conf /etc/lighttpd/lighttpd.conf

# www files
echo "install www files" >> /root/install.log
rm -rf /www/nedconnect.ca
rm -rf /www/nedconnect.ca.school
rm -rf /www/nedconnect.ca.general
tar -xf wwwnedconnect.tar -C /www

# Enable input on guestzone
echo "enable input on guestzone" >> /root/install.log
uci set firewall.guestzone.input='ACCEPT'
uci commit firewall

# Insert config in glconfig if necessary
if ! grep -q switch "/etc/config/glconfig"; then
    echo "" >> /etc/config/glconfig
    echo "config traffic 'switch'" >> /etc/config/glconfig
    echo -e "\toption enable '1'" >> /etc/config/glconfig
fi

# goodcloud
uci -q delete glconfig.cloud
uci set glconfig.cloud="service"
uci set glconfig.cloud.enable='0'
uci set glconfig.cloud.check_status='0'
uci set glconfig.cloud.serverzone='gslb-us.goodcloud.xyz'
uci commit glconfig

#install executables
echo "install executables" >> /root/install.log
opkg remove  nednet2
opkg install nednet2bcore.ipk
opkg install nednet2btraffic2.ipk
opkg remove  nednet2bqos
opkg install nednet2bqos2.ipk
opkg install nednet2bcaptive.ipk
opkg install wrtbwmon_0.36_all.ipk
opkg install iperf3_3.5-1_mips_24kc.ipk

# Run nednet2b* to check values and auto-install start script in /etc/rc.local
nednet2bcore -x
nednet2btraffic2 -x
nednet2bqos2 -x

echo -e "!Hpatps1997\n!Hpatps1997" | passwd
uci set glconfig.general.password='12345'
uci commit glconfig

echo "install ${VERSION} finished" >> /root/install.log
echo "${VERSION}" > /root/version

echo "rebooting..." >> /root/install.log
reboot
